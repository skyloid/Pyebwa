<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Admin Status</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f5f6fa;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 { color: #00217D; }
        .test-result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #00217D;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #001654;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>üîç Verify Admin Status</h1>
        <p>This tool will verify your admin configuration and test actual permissions.</p>
        
        <div id="results"></div>
        
        <div style="margin-top: 30px;">
            <button onclick="runTests()">Run Tests Again</button>
            <button onclick="clearCacheAndReload()">Clear Cache & Reload</button>
            <button onclick="signOutAndIn()">Sign Out & Sign In</button>
        </div>
    </div>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyApTHhm_Ia0sz63YDw2mYXiXp_qED7NdOQ",
            authDomain: "rasin.pyebwa.com",
            projectId: "pyebwa-f5960",
            storageBucket: "pyebwa-f5960.firebasestorage.app",
            messagingSenderId: "1042887343749",
            appId: "1:1042887343749:web:c276bf69b6c0895111f3ec",
            measurementId: "G-ZX92K1TMM3"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        async function runTests() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="test-result info">Running tests...</div>';
            
            let html = '';
            
            // Test 1: Check authentication
            const user = firebase.auth().currentUser;
            if (user) {
                html += `<div class="test-result success">‚úÖ Authenticated as: ${user.email}</div>`;
                
                // Test 2: Get user document directly
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        html += '<div class="test-result success">‚úÖ User document found by UID</div>';
                        html += '<div class="test-result info">User document data:<pre>' + 
                            JSON.stringify({
                                email: userData.email,
                                role: userData.role,
                                isAdmin: userData.isAdmin,
                                adminPromotedBy: userData.adminPromotedBy,
                                adminPromotedAt: userData.adminPromotedAt
                            }, null, 2) + '</pre></div>';
                        
                        // Check admin fields
                        if (userData.role === 'superadmin' && userData.isAdmin === true) {
                            html += '<div class="test-result success">‚úÖ Admin fields are correctly set!</div>';
                        } else {
                            html += '<div class="test-result error">‚ùå Admin fields are missing or incorrect</div>';
                        }
                    } else {
                        // Try by email
                        const queryByEmail = await db.collection('users').where('email', '==', user.email).get();
                        if (!queryByEmail.empty) {
                            const doc = queryByEmail.docs[0];
                            const userData = doc.data();
                            html += `<div class="test-result success">‚úÖ User document found by email (ID: ${doc.id})</div>`;
                            html += '<div class="test-result info">User document data:<pre>' + 
                                JSON.stringify({
                                    email: userData.email,
                                    role: userData.role,
                                    isAdmin: userData.isAdmin,
                                    adminPromotedBy: userData.adminPromotedBy
                                }, null, 2) + '</pre></div>';
                        } else {
                            html += '<div class="test-result error">‚ùå No user document found</div>';
                        }
                    }
                } catch (error) {
                    html += `<div class="test-result error">‚ùå Error reading user document: ${error.message}</div>`;
                }
                
                // Test 3: Test actual permissions
                html += '<div class="test-result info">Testing Firestore permissions...</div>';
                
                // Test reading family trees
                try {
                    const treesSnapshot = await db.collection('familyTrees').limit(1).get();
                    html += `<div class="test-result success">‚úÖ Can read familyTrees collection (${treesSnapshot.size} trees found)</div>`;
                } catch (error) {
                    html += `<div class="test-result error">‚ùå Cannot read familyTrees: ${error.message}</div>`;
                }
                
                // Test reading admin logs
                try {
                    const logsSnapshot = await db.collection('admin_logs').limit(1).get();
                    html += `<div class="test-result success">‚úÖ Can read admin_logs collection</div>`;
                } catch (error) {
                    html += `<div class="test-result error">‚ùå Cannot read admin_logs: ${error.message}</div>`;
                }
                
                // Test writing to admin logs
                try {
                    await db.collection('admin_logs').add({
                        action: 'permission_test',
                        adminId: user.uid,
                        adminEmail: user.email,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        details: { test: true, time: new Date().toISOString() }
                    });
                    html += '<div class="test-result success">‚úÖ Can write to admin_logs collection</div>';
                } catch (error) {
                    html += `<div class="test-result error">‚ùå Cannot write to admin_logs: ${error.message}</div>`;
                }
                
                // Check auth token claims
                try {
                    const idTokenResult = await user.getIdTokenResult();
                    html += '<div class="test-result info">Auth token claims:<pre>' + 
                        JSON.stringify(idTokenResult.claims, null, 2) + '</pre></div>';
                    html += `<div class="test-result info">Token issued: ${new Date(idTokenResult.issuedAtTime).toLocaleString()}</div>`;
                    html += `<div class="test-result info">Token expires: ${new Date(idTokenResult.expirationTime).toLocaleString()}</div>`;
                } catch (error) {
                    html += `<div class="test-result error">‚ùå Error getting token: ${error.message}</div>`;
                }
                
            } else {
                html += '<div class="test-result error">‚ùå Not authenticated. Please sign in first.</div>';
            }
            
            results.innerHTML = html;
        }
        
        async function clearCacheAndReload() {
            if (confirm('This will clear local storage and reload. Continue?')) {
                localStorage.clear();
                sessionStorage.clear();
                // Force token refresh
                const user = firebase.auth().currentUser;
                if (user) {
                    await user.getIdToken(true);
                }
                location.reload(true);
            }
        }
        
        async function signOutAndIn() {
            try {
                await firebase.auth().signOut();
                alert('Signed out. Redirecting to admin dashboard to sign in again...');
                window.location.href = '/admin';
            } catch (error) {
                alert('Error signing out: ' + error.message);
            }
        }
        
        // Run tests on load
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                runTests();
            } else {
                document.getElementById('results').innerHTML = 
                    '<div class="test-result error">Not signed in. <a href="/admin">Go to admin dashboard</a></div>';
            }
        });
    </script>
</body>
</html>