<!DOCTYPE html>
<html>
<head>
    <title>Login Loop Diagnostics</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            background: #f5f5f5;
            font-family: monospace;
            font-size: 12px;
        }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        #flowChart {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Login Loop Diagnostics</h1>
    
    <div class="section">
        <h2>Current Page Information</h2>
        <div id="pageInfo"></div>
    </div>
    
    <div class="section">
        <h2>URL Parameters</h2>
        <div id="urlParams"></div>
    </div>
    
    <div class="section">
        <h2>Firebase Auth State</h2>
        <div id="authState"></div>
        <button onclick="checkAuthState()">Refresh Auth State</button>
    </div>
    
    <div class="section">
        <h2>Storage State</h2>
        <div id="storageState"></div>
        <button onclick="checkStorage()">Check Storage</button>
        <button onclick="clearStorage()">Clear Storage</button>
    </div>
    
    <div class="section">
        <h2>Authentication Flow</h2>
        <div id="flowChart"></div>
    </div>
    
    <div class="section">
        <h2>Test Scenarios</h2>
        <button onclick="simulateLogin()">Simulate Login Flow</button>
        <button onclick="testRedirects()">Test Redirect Chain</button>
        <button onclick="testCrossDomain()">Test Cross-Domain Auth</button>
    </div>
    
    <div class="section">
        <h2>Debug Logs</h2>
        <div id="debugLogs"></div>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyApTHhm_Ia0sz63YDw2mYXiXp_qED7NdOQ",
            authDomain: "pyebwa-f5960.firebaseapp.com",
            projectId: "pyebwa-f5960",
            storageBucket: "pyebwa-f5960.firebasestorage.app",
            messagingSenderId: "1042887343749",
            appId: "1:1042887343749:web:c276bf69b6c0895111f3ec",
            measurementId: "G-ZX92K1TMM3"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        
        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${message}`;
            
            // Add to page
            const logsDiv = document.getElementById('debugLogs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = logEntry;
            logsDiv.appendChild(entry);
            
            // Store in localStorage
            const logs = JSON.parse(localStorage.getItem('loginLoopDiagnostics') || '[]');
            logs.push({ timestamp, message, type });
            localStorage.setItem('loginLoopDiagnostics', JSON.stringify(logs.slice(-50)));
        }
        
        // Page info
        function showPageInfo() {
            const info = document.getElementById('pageInfo');
            info.innerHTML = `
                <p><strong>Current URL:</strong> ${window.location.href}</p>
                <p><strong>Host:</strong> ${window.location.host}</p>
                <p><strong>Protocol:</strong> ${window.location.protocol}</p>
                <p><strong>Pathname:</strong> ${window.location.pathname}</p>
                <p><strong>Referrer:</strong> ${document.referrer || 'None'}</p>
            `;
        }
        
        // URL parameters
        function showUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const div = document.getElementById('urlParams');
            let html = '<ul>';
            
            if (params.toString()) {
                for (const [key, value] of params) {
                    html += `<li><strong>${key}:</strong> ${value}</li>`;
                }
            } else {
                html += '<li>No URL parameters</li>';
            }
            
            html += '</ul>';
            div.innerHTML = html;
        }
        
        // Check auth state
        function checkAuthState() {
            const div = document.getElementById('authState');
            const user = auth.currentUser;
            
            if (user) {
                div.innerHTML = `
                    <p class="success">User is authenticated</p>
                    <p><strong>UID:</strong> ${user.uid}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Display Name:</strong> ${user.displayName || 'Not set'}</p>
                `;
                log('User authenticated: ' + user.email, 'success');
            } else {
                div.innerHTML = '<p class="error">No user authenticated</p>';
                log('No user authenticated', 'warning');
            }
        }
        
        // Check storage
        function checkStorage() {
            const div = document.getElementById('storageState');
            let html = '<h3>LocalStorage:</h3><ul>';
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                html += `<li><strong>${key}:</strong> ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}</li>`;
            }
            
            html += '</ul><h3>SessionStorage:</h3><ul>';
            
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                const value = sessionStorage.getItem(key);
                html += `<li><strong>${key}:</strong> ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}</li>`;
            }
            
            html += '</ul>';
            div.innerHTML = html;
            log('Storage checked', 'info');
        }
        
        // Clear storage
        function clearStorage() {
            if (confirm('Clear all storage data?')) {
                localStorage.clear();
                sessionStorage.clear();
                log('Storage cleared', 'warning');
                checkStorage();
            }
        }
        
        // Show authentication flow
        function showAuthFlow() {
            const div = document.getElementById('flowChart');
            div.innerHTML = `
AUTHENTICATION FLOW ANALYSIS:

1. User clicks login on www.pyebwa.com
   ↓
2. Redirects to secure.pyebwa.com with redirect parameter
   ↓
3. User authenticates (email/password or social)
   ↓
4. On success, redirects to www.pyebwa.com with auth=success
   ↓
5. www.pyebwa.com checks Firebase auth state
   ↓
6. If authenticated, redirects to rasin.pyebwa.com/app
   ↓
7. rasin.pyebwa.com/app checks auth state
   ↓
8. If not authenticated, redirects back to www.pyebwa.com

POTENTIAL LOOP POINTS:
- Step 5: Firebase auth state might not be synced
- Step 7: Cross-domain auth state might be lost
- URL parameters might trigger repeated redirects
            `;
        }
        
        // Simulate login flow
        async function simulateLogin() {
            log('=== Starting login flow simulation ===', 'info');
            
            // Check current auth state
            log('Checking current auth state...', 'info');
            const user = auth.currentUser;
            
            if (user) {
                log(`User already authenticated: ${user.email}`, 'success');
                
                // Check if we're on rasin.pyebwa.com
                if (window.location.host === 'rasin.pyebwa.com') {
                    log('Already on rasin.pyebwa.com - no redirect needed', 'success');
                } else {
                    log('Would redirect to rasin.pyebwa.com/app', 'info');
                }
            } else {
                log('No user authenticated', 'warning');
                log('Would redirect to secure.pyebwa.com for login', 'info');
            }
            
            // Check URL parameters
            const params = new URLSearchParams(window.location.search);
            if (params.get('login') === 'true') {
                log('Login parameter detected - might cause loop if auth fails', 'warning');
            }
            if (params.get('auth') === 'success') {
                log('Auth success parameter detected - should have valid auth', 'warning');
            }
        }
        
        // Test redirects
        function testRedirects() {
            log('=== Testing redirect chain ===', 'info');
            
            const redirectChain = [
                { from: 'www.pyebwa.com', to: 'secure.pyebwa.com', condition: 'Not authenticated' },
                { from: 'secure.pyebwa.com', to: 'www.pyebwa.com', condition: 'After login' },
                { from: 'www.pyebwa.com', to: 'rasin.pyebwa.com/app', condition: 'Authenticated' },
                { from: 'rasin.pyebwa.com/app', to: 'www.pyebwa.com', condition: 'Not authenticated' }
            ];
            
            redirectChain.forEach(redirect => {
                log(`${redirect.from} → ${redirect.to} (${redirect.condition})`, 'info');
            });
            
            // Check for potential loops
            log('Checking for redirect loops...', 'info');
            
            if (!auth.currentUser) {
                log('POTENTIAL LOOP: No auth + login parameter could cause infinite redirects', 'error');
            }
        }
        
        // Test cross-domain auth
        async function testCrossDomain() {
            log('=== Testing cross-domain authentication ===', 'info');
            
            // Check if we can access auth from different domains
            log(`Current domain: ${window.location.host}`, 'info');
            log(`Auth domain: ${auth.app.options.authDomain}`, 'info');
            
            // Try to get ID token
            if (auth.currentUser) {
                try {
                    const token = await auth.currentUser.getIdToken();
                    log('Successfully retrieved ID token', 'success');
                    log(`Token length: ${token.length}`, 'info');
                } catch (error) {
                    log(`Failed to get ID token: ${error.message}`, 'error');
                }
            } else {
                log('No user to test ID token with', 'warning');
            }
            
            // Check auth persistence
            log(`Auth persistence: ${auth.app.options.persistence || 'default'}`, 'info');
        }
        
        // Clear logs
        function clearLogs() {
            document.getElementById('debugLogs').innerHTML = '';
            localStorage.removeItem('loginLoopDiagnostics');
            log('Logs cleared', 'info');
        }
        
        // Load stored logs
        function loadStoredLogs() {
            const logs = JSON.parse(localStorage.getItem('loginLoopDiagnostics') || '[]');
            logs.forEach(logEntry => {
                const entry = document.createElement('div');
                entry.className = `log-entry ${logEntry.type}`;
                entry.textContent = `[${logEntry.timestamp}] ${logEntry.message}`;
                document.getElementById('debugLogs').appendChild(entry);
            });
        }
        
        // Auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                log(`Auth state changed: User ${user.email} is signed in`, 'success');
            } else {
                log('Auth state changed: No user signed in', 'warning');
            }
            checkAuthState();
        });
        
        // Initialize on load
        window.addEventListener('load', () => {
            showPageInfo();
            showUrlParams();
            checkAuthState();
            checkStorage();
            showAuthFlow();
            loadStoredLogs();
            
            // Log page load
            log(`Page loaded: ${window.location.href}`, 'info');
            
            // Check for redirect parameters
            const params = new URLSearchParams(window.location.search);
            if (params.has('login') || params.has('auth')) {
                log('Redirect parameters detected - possible loop point', 'warning');
            }
        });
    </script>
</body>
</html>