<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSO Manual Test - Pyebwa</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #00217D;
            text-align: center;
        }
        
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-step {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #00217D;
        }
        
        .test-step h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .iframe-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .iframe-wrapper {
            flex: 1;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .iframe-header {
            background: #00217D;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        
        .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .status-indicator.pending {
            background: #fbbf24;
        }
        
        .status-indicator.success {
            background: #10b981;
        }
        
        .status-indicator.error {
            background: #ef4444;
        }
        
        .test-button {
            background: #00217D;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #001551;
        }
        
        .results {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        
        .warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .auth-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .auth-item {
            background: #eff6ff;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .auth-item h4 {
            margin: 0 0 10px 0;
            color: #1e40af;
        }
        
        .auth-value {
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>Single Sign-On (SSO) Manual Test</h1>
    
    <div class="warning">
        <strong>⚠️ Important:</strong> This test requires you to have valid login credentials for Pyebwa. 
        The test will verify that authentication works across both domains (pyebwa.com and rasin.pyebwa.com).
    </div>
    
    <div class="test-section">
        <h2>Current Authentication Status</h2>
        <div class="auth-info">
            <div class="auth-item">
                <h4>Firebase Auth</h4>
                <div class="auth-value" id="firebaseAuth">Checking...</div>
            </div>
            <div class="auth-item">
                <h4>Local Storage</h4>
                <div class="auth-value" id="localStorageAuth">Checking...</div>
            </div>
            <div class="auth-item">
                <h4>Session Storage</h4>
                <div class="auth-value" id="sessionStorageAuth">Checking...</div>
            </div>
            <div class="auth-item">
                <h4>Cookies</h4>
                <div class="auth-value" id="cookieAuth">Checking...</div>
            </div>
        </div>
        <button class="test-button" onclick="updateAuthStatus()">Refresh Status</button>
    </div>
    
    <div class="test-section">
        <h2>Test Steps</h2>
        
        <div class="test-step">
            <h3><span class="status-indicator pending" id="step1"></span>Step 1: Login to rasin.pyebwa.com</h3>
            <p>First, login using the iframe below or in a new tab:</p>
            <button class="test-button" onclick="window.open('https://rasin.pyebwa.com/login.html', '_blank')">Open Login in New Tab</button>
            <button class="test-button" onclick="checkStep1()">Check Login Status</button>
        </div>
        
        <div class="test-step">
            <h3><span class="status-indicator pending" id="step2"></span>Step 2: Verify App Access</h3>
            <p>After logging in, verify you can access the app without re-authenticating:</p>
            <button class="test-button" onclick="window.open('https://rasin.pyebwa.com/app/', '_blank')">Open App in New Tab</button>
            <button class="test-button" onclick="checkStep2()">Check App Access</button>
        </div>
        
        <div class="test-step">
            <h3><span class="status-indicator pending" id="step3"></span>Step 3: Test Cross-Domain Access</h3>
            <p>Check if you're recognized on the main domain:</p>
            <button class="test-button" onclick="window.open('https://pyebwa.com', '_blank')">Open pyebwa.com</button>
            <button class="test-button" onclick="checkStep3()">Check Main Site</button>
        </div>
        
        <div class="test-step">
            <h3><span class="status-indicator pending" id="step4"></span>Step 4: Test Persistence</h3>
            <p>Refresh this page and check if authentication persists:</p>
            <button class="test-button" onclick="location.reload()">Refresh Page</button>
            <button class="test-button" onclick="runAllChecks()">Run All Checks</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Side-by-Side Test</h2>
        <p>Use these iframes to test authentication across domains simultaneously:</p>
        
        <div class="iframe-container">
            <div class="iframe-wrapper">
                <div class="iframe-header">rasin.pyebwa.com/app</div>
                <iframe id="appFrame" src="https://rasin.pyebwa.com/app/"></iframe>
            </div>
            <div class="iframe-wrapper">
                <div class="iframe-header">pyebwa.com</div>
                <iframe id="mainFrame" src="https://pyebwa.com"></iframe>
            </div>
        </div>
        
        <button class="test-button" onclick="reloadFrames()">Reload Both Frames</button>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div class="results" id="results">No tests run yet. Click "Run All Checks" to begin.</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyApTHhm_Ia0sz63YDw2mYXiXp_qED7NdOQ",
            authDomain: "pyebwa-f5960.firebaseapp.com",
            projectId: "pyebwa-f5960",
            storageBucket: "pyebwa-f5960.appspot.com",
            messagingSenderId: "1042887343749",
            appId: "1:1042887343749:web:c276bf69b6c0895111f3ec"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        
        // Results logging
        function log(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
        }
        
        function clearResults() {
            document.getElementById('results').textContent = '';
        }
        
        // Update authentication status
        function updateAuthStatus() {
            // Firebase Auth
            const user = auth.currentUser;
            document.getElementById('firebaseAuth').textContent = 
                user ? `Logged in: ${user.email}` : 'Not logged in';
            
            // Local Storage
            try {
                const localAuth = localStorage.getItem('pyebwaAuthState');
                document.getElementById('localStorageAuth').textContent = 
                    localAuth ? 'Present' : 'Empty';
            } catch (e) {
                document.getElementById('localStorageAuth').textContent = 'Error: ' + e.message;
            }
            
            // Session Storage
            try {
                const sessionAuth = sessionStorage.getItem('pyebwaAuthState');
                document.getElementById('sessionStorageAuth').textContent = 
                    sessionAuth ? 'Present' : 'Empty';
            } catch (e) {
                document.getElementById('sessionStorageAuth').textContent = 'Error: ' + e.message;
            }
            
            // Cookies
            const hasCookies = document.cookie.includes('pyebwa');
            document.getElementById('cookieAuth').textContent = 
                hasCookies ? 'Present' : 'Empty';
        }
        
        // Step checks
        async function checkStep1() {
            log('Checking Step 1: Login status...');
            const user = auth.currentUser;
            if (user) {
                document.getElementById('step1').className = 'status-indicator success';
                log(`✓ Logged in as: ${user.email}`);
                return true;
            } else {
                document.getElementById('step1').className = 'status-indicator error';
                log('✗ Not logged in');
                return false;
            }
        }
        
        async function checkStep2() {
            log('Checking Step 2: App access...');
            // Check if we can fetch app resources
            try {
                const response = await fetch('https://rasin.pyebwa.com/app/');
                if (response.ok) {
                    document.getElementById('step2').className = 'status-indicator success';
                    log('✓ App is accessible');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('step2').className = 'status-indicator error';
                log(`✗ App access error: ${error.message}`);
                return false;
            }
        }
        
        async function checkStep3() {
            log('Checking Step 3: Cross-domain access...');
            // This is limited by CORS, so we'll check localStorage instead
            const hasAuth = localStorage.getItem('pyebwaAuthState') || 
                           sessionStorage.getItem('pyebwaAuthState');
            
            if (hasAuth) {
                document.getElementById('step3').className = 'status-indicator success';
                log('✓ Authentication data available for cross-domain');
                return true;
            } else {
                document.getElementById('step3').className = 'status-indicator error';
                log('✗ No authentication data for cross-domain');
                return false;
            }
        }
        
        async function checkStep4() {
            log('Checking Step 4: Persistence...');
            const user = auth.currentUser;
            const hasStorage = localStorage.getItem('pyebwaAuthState') || 
                              sessionStorage.getItem('pyebwaAuthState');
            
            if (user && hasStorage) {
                document.getElementById('step4').className = 'status-indicator success';
                log('✓ Authentication persisted correctly');
                return true;
            } else {
                document.getElementById('step4').className = 'status-indicator pending';
                log('⚠ Persistence check requires page refresh');
                return false;
            }
        }
        
        async function runAllChecks() {
            clearResults();
            log('Running all SSO checks...\n');
            
            updateAuthStatus();
            
            const step1 = await checkStep1();
            const step2 = await checkStep2();
            const step3 = await checkStep3();
            const step4 = await checkStep4();
            
            log('\n=== Summary ===');
            log(`Step 1 (Login): ${step1 ? 'PASS' : 'FAIL'}`);
            log(`Step 2 (App Access): ${step2 ? 'PASS' : 'FAIL'}`);
            log(`Step 3 (Cross-domain): ${step3 ? 'PASS' : 'FAIL'}`);
            log(`Step 4 (Persistence): ${step4 ? 'PASS' : 'PENDING'}`);
            
            if (step1 && step2 && step3) {
                log('\n✅ SSO is working correctly!');
            } else {
                log('\n❌ SSO has issues that need to be resolved.');
            }
        }
        
        function reloadFrames() {
            document.getElementById('appFrame').src = 'https://rasin.pyebwa.com/app/';
            document.getElementById('mainFrame').src = 'https://pyebwa.com';
            log('Reloaded both iframes');
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            updateAuthStatus();
            
            // Listen for auth changes
            auth.onAuthStateChanged((user) => {
                log(`Auth state changed: ${user ? user.email : 'No user'}`);
                updateAuthStatus();
            });
            
            log('SSO test page ready. Follow the steps above to test authentication.');
        });
    </script>
</body>
</html>