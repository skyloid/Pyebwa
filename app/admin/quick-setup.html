<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Admin Setup - Pyebwa</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f5f6fa;
        }
        .setup-container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #00217D;
            margin-bottom: 24px;
        }
        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        button {
            background: #00217D;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px;
        }
        button:hover {
            background: #001654;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="setup-container">
        <h1>Quick Admin Setup</h1>
        <p>Since the regular setup is blocked by permissions, let's use the browser console method.</p>
        
        <div id="status" class="status info">
            Checking your authentication...
        </div>
        
        <div id="instructions" style="display: none;">
            <h3>Manual Setup Instructions:</h3>
            <p>Copy and paste this code into your browser console (F12 ‚Üí Console tab):</p>
            
            <div class="code-block" id="setupCode">
                <!-- Code will be generated here -->
            </div>
            
            <button onclick="copyCode()">Copy Code</button>
            <button onclick="openConsole()">Open Browser Console</button>
        </div>
        
        <div id="autoSetup" style="display: none;">
            <p>Or try the automatic setup:</p>
            <button onclick="attemptDirectSetup()">Try Direct Setup</button>
        </div>
    </div>

    <script src="/app/js/firebase-config.js"></script>
    <script>
        let currentUser = null;
        let authCheckTimeout = null;
        
        window.addEventListener('load', () => {
            console.log('üîç Checking Firebase authentication...');
            
            // Set a timeout for auth detection
            authCheckTimeout = setTimeout(() => {
                console.log('‚è∞ Auth check timeout - providing manual method');
                showStatus('‚ö†Ô∏è Auth detection timeout. Using manual setup method.', 'info');
                generateManualSetupCode();
                document.getElementById('instructions').style.display = 'block';
            }, 5000);
            
            // Check if Firebase is ready
            if (typeof firebase === 'undefined') {
                console.error('‚ùå Firebase not loaded');
                clearTimeout(authCheckTimeout);
                showStatus('‚ùå Firebase not loaded. Please refresh the page.', 'error');
                return;
            }
            
            // Try to get current user immediately
            const immediateUser = firebase.auth().currentUser;
            if (immediateUser) {
                console.log('‚úÖ Found immediate user:', immediateUser.email);
                handleAuthUser(immediateUser);
                return;
            }
            
            // Listen for auth state changes
            firebase.auth().onAuthStateChanged((user) => {
                console.log('üîê Auth state changed:', user ? user.email : 'No user');
                if (authCheckTimeout) {
                    clearTimeout(authCheckTimeout);
                    authCheckTimeout = null;
                }
                
                if (user) {
                    handleAuthUser(user);
                } else {
                    showStatus('‚ùå Not authenticated. Please sign in first.', 'error');
                    generateManualSetupCode();
                    document.getElementById('instructions').style.display = 'block';
                    
                    setTimeout(() => {
                        if (confirm('You need to sign in first. Go to main app?')) {
                            window.location.href = '/app/';
                        }
                    }, 2000);
                }
            });
        });
        
        function handleAuthUser(user) {
            currentUser = user;
            showStatus(`‚úÖ Authenticated as ${user.email}`, 'success');
            generateSetupCode(user);
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('autoSetup').style.display = 'block';
        }
        
        function generateManualSetupCode() {
            const code = `
// Manual Admin Setup - Run this in console after signing in
(async function() {
    try {
        console.log('üîß Manual admin setup starting...');
        
        // Check if user is authenticated
        const user = firebase.auth().currentUser;
        if (!user) {
            console.error('‚ùå Not authenticated. Please sign in first.');
            return;
        }
        
        console.log('üë§ Found user:', user.email);
        
        // Find user document
        const usersRef = firebase.firestore().collection('users');
        const querySnapshot = await usersRef.where('email', '==', user.email).get();
        
        if (querySnapshot.empty) {
            console.error('‚ùå User document not found');
            return;
        }
        
        const userDoc = querySnapshot.docs[0];
        const userId = userDoc.id;
        console.log('üìÑ Found user document:', userId);
        
        // Update with admin role
        await usersRef.doc(userId).update({
            role: 'superadmin',
            isAdmin: true,
            adminPromotedAt: firebase.firestore.FieldValue.serverTimestamp(),
            adminPromotedBy: 'setup-tool'
        });
        
        console.log('‚úÖ Successfully promoted', user.email, 'to superadmin!');
        console.log('üéâ You can now access the admin dashboard at /admin');
        
    } catch (error) {
        console.error('‚ùå Setup failed:', error);
        console.log('üí° Make sure you are signed in and try again');
    }
})();`;
            
            document.getElementById('setupCode').textContent = code.trim();
        }
        
        function generateSetupCode(user) {
            const code = `
// Quick Admin Setup for ${user.email}
(async function() {
    try {
        console.log('üîß Setting up admin role for ${user.email}...');
        
        // Find your user document
        const usersRef = firebase.firestore().collection('users');
        const querySnapshot = await usersRef.where('email', '==', '${user.email}').get();
        
        if (querySnapshot.empty) {
            console.error('‚ùå User not found');
            return;
        }
        
        const userDoc = querySnapshot.docs[0];
        const userId = userDoc.id;
        console.log('üë§ Found user:', userId);
        
        // Update with admin role using the temp rule
        await usersRef.doc(userId).update({
            role: 'superadmin',
            isAdmin: true,
            adminPromotedAt: firebase.firestore.FieldValue.serverTimestamp(),
            adminPromotedBy: 'setup-tool'
        });
        
        console.log('‚úÖ Successfully promoted ${user.email} to superadmin!');
        console.log('üéâ You can now access the admin dashboard');
        
        // Test admin access
        const updatedDoc = await usersRef.doc(userId).get();
        console.log('üîç Updated user data:', updatedDoc.data());
        
    } catch (error) {
        console.error('‚ùå Setup failed:', error);
        console.log('üí° Try the alternative method in the setup page');
    }
})();`;
            
            document.getElementById('setupCode').textContent = code.trim();
        }
        
        function copyCode() {
            const code = document.getElementById('setupCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showStatus('‚úÖ Code copied to clipboard! Now paste it in the browser console.', 'success');
            }).catch(() => {
                showStatus('‚ùå Could not copy code. Please select and copy manually.', 'error');
            });
        }
        
        function openConsole() {
            showStatus('‚ÑπÔ∏è Press F12 or right-click ‚Üí Inspect ‚Üí Console tab, then paste the code', 'info');
        }
        
        async function attemptDirectSetup() {
            if (!currentUser) {
                showStatus('‚ùå Not authenticated', 'error');
                return;
            }
            
            try {
                showStatus('üîß Attempting direct setup...', 'info');
                
                // Try direct firestore update
                const usersRef = firebase.firestore().collection('users');
                const querySnapshot = await usersRef.where('email', '==', currentUser.email).get();
                
                if (querySnapshot.empty) {
                    throw new Error('User document not found');
                }
                
                const userDoc = querySnapshot.docs[0];
                const userId = userDoc.id;
                
                await usersRef.doc(userId).update({
                    role: 'superadmin',
                    isAdmin: true,
                    adminPromotedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    adminPromotedBy: 'setup-tool'
                });
                
                showStatus('‚úÖ Success! You are now a superadmin. Try accessing the admin dashboard.', 'success');
                
                setTimeout(() => {
                    window.location.href = '/admin';
                }, 2000);
                
            } catch (error) {
                console.error('Direct setup failed:', error);
                showStatus('‚ùå Direct setup failed: ' + error.message + '. Please use the console method above.', 'error');
            }
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = \`status \${type}\`;
        }
    </script>
</body>
</html>