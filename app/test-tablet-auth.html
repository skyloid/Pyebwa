<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Tablet Auth Test - Pyebwa</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            line-height: 1.6;
            background: #f5f7fa;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #00217D;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #00217D;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .status {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        pre {
            background: #333;
            color: #0f0;
            padding: 10px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Tablet Authentication Test</h1>
    
    <div class="test-section">
        <h2>1. Device Detection Test</h2>
        <div id="deviceTest"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Firebase Configuration Test</h2>
        <div id="firebaseTest"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Storage Test</h2>
        <div id="storageTest"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Redirect Cooldown Test</h2>
        <div id="cooldownTest"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Auth State Test</h2>
        <div id="authTest"></div>
        <button onclick="testAuthFlow()">Test Auth Flow</button>
        <button onclick="clearAllData()">Clear All Data</button>
    </div>
    
    <div class="test-section">
        <h2>6. Loop Detection Test</h2>
        <div id="loopTest"></div>
        <button onclick="simulateLoop()">Simulate Loop</button>
        <button onclick="clearLoopData()">Clear Loop Data</button>
    </div>
    
    <div class="test-section">
        <h2>7. Cross-Domain Test</h2>
        <div id="crossDomainTest"></div>
        <button onclick="testCrossDomain()">Test Cross-Domain Auth</button>
    </div>
    
    <div class="test-section">
        <h2>8. Performance Metrics</h2>
        <div id="performanceTest"></div>
    </div>
    
    <div class="test-section">
        <h2>9. Automated Test Suite</h2>
        <div id="automatedTests"></div>
        <button onclick="runAutomatedTests()">Run All Tests</button>
        <button onclick="exportTestResults()">Export Results</button>
    </div>
    
    <div class="test-section">
        <h2>10. Console Log</h2>
        <pre id="console"></pre>
    </div>

    <script src="/app/js/firebase-config.js?v=4"></script>
    <script src="/app/js/device-detection.js?v=1"></script>
    <script src="/tablet-auth-test-suite.js"></script>
    
    <script>
        const log = (message, type = 'info') => {
            const console = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            console.innerHTML += `[${time}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        };
        
        // Test 1: Device Detection
        const deviceTest = document.getElementById('deviceTest');
        if (window.DeviceDetection) {
            const info = window.DeviceDetection.getDeviceInfo();
            const isTablet = window.DeviceDetection.isTablet();
            
            deviceTest.innerHTML = `
                <div class="status ${isTablet ? 'warning' : 'info'}">
                    Device Type: ${info.type} ${isTablet ? '(TABLET DETECTED)' : ''}
                </div>
                <div class="status info">
                    User Agent: ${info.userAgent}
                </div>
                <div class="status info">
                    Screen: ${info.screenWidth} x ${info.screenHeight}
                </div>
                <div class="status info">
                    Touch Support: ${info.touchSupport ? 'Yes' : 'No'}
                </div>
            `;
            log(`Device detection: ${info.type} (tablet: ${isTablet})`);
        } else {
            deviceTest.innerHTML = '<div class="status error">Device detection script not loaded!</div>';
            log('ERROR: Device detection not available', 'error');
        }
        
        // Test 2: Firebase Configuration
        const firebaseTest = document.getElementById('firebaseTest');
        if (typeof firebase !== 'undefined') {
            firebaseTest.innerHTML = `
                <div class="status success">Firebase loaded successfully</div>
                <div class="status info">Auth Domain: ${firebase.app().options.authDomain}</div>
                <div class="status info">Project ID: ${firebase.app().options.projectId}</div>
            `;
            log('Firebase loaded successfully');
            
            // Check auth
            if (firebase.auth) {
                const auth = firebase.auth();
                auth.onAuthStateChanged((user) => {
                    const authDiv = document.getElementById('authTest');
                    if (user) {
                        authDiv.innerHTML = `
                            <div class="status success">Authenticated as: ${user.email}</div>
                            <div class="status info">UID: ${user.uid}</div>
                        `;
                        log(`Auth state: Authenticated as ${user.email}`);
                    } else {
                        authDiv.innerHTML = '<div class="status warning">Not authenticated</div>';
                        log('Auth state: Not authenticated');
                    }
                });
            }
        } else {
            firebaseTest.innerHTML = '<div class="status error">Firebase not loaded!</div>';
            log('ERROR: Firebase not loaded', 'error');
        }
        
        // Test 3: Storage
        const storageTest = document.getElementById('storageTest');
        try {
            // Test localStorage
            localStorage.setItem('test', 'value');
            const testValue = localStorage.getItem('test');
            localStorage.removeItem('test');
            
            // Test sessionStorage
            sessionStorage.setItem('test', 'value');
            const testSession = sessionStorage.getItem('test');
            sessionStorage.removeItem('test');
            
            // Get current values
            const redirectData = sessionStorage.getItem('pyebwaRedirectData');
            const lastRedirect = localStorage.getItem('lastRedirectTime');
            const debugLogs = localStorage.getItem('pyebwaDebugLogs');
            
            storageTest.innerHTML = `
                <div class="status success">Storage is working</div>
                <div class="status info">Redirect Data: ${redirectData || 'None'}</div>
                <div class="status info">Last Redirect: ${lastRedirect ? new Date(parseInt(lastRedirect)).toLocaleString() : 'None'}</div>
                <div class="status info">Debug Logs: ${debugLogs ? JSON.parse(debugLogs).length + ' entries' : 'None'}</div>
            `;
            log('Storage test passed');
        } catch (e) {
            storageTest.innerHTML = `<div class="status error">Storage error: ${e.message}</div>`;
            log(`ERROR: Storage test failed - ${e.message}`, 'error');
        }
        
        // Test 4: Cooldown
        const cooldownTest = document.getElementById('cooldownTest');
        const lastRedirectTime = parseInt(localStorage.getItem('lastRedirectTime') || '0');
        const now = Date.now();
        const isTablet = window.DeviceDetection && window.DeviceDetection.isTablet();
        const cooldownTime = isTablet ? 60000 : 30000;
        const timeSinceRedirect = now - lastRedirectTime;
        const cooldownActive = timeSinceRedirect < cooldownTime;
        const cooldownRemaining = Math.max(0, cooldownTime - timeSinceRedirect);
        
        cooldownTest.innerHTML = `
            <div class="status ${cooldownActive ? 'warning' : 'success'}">
                Cooldown: ${cooldownActive ? 'ACTIVE' : 'Inactive'}
            </div>
            <div class="status info">
                Cooldown Duration: ${cooldownTime / 1000}s (${isTablet ? 'tablet' : 'desktop'})
            </div>
            <div class="status info">
                Time Since Last Redirect: ${Math.round(timeSinceRedirect / 1000)}s
            </div>
            ${cooldownActive ? `<div class="status warning">Cooldown Remaining: ${Math.round(cooldownRemaining / 1000)}s</div>` : ''}
        `;
        log(`Cooldown: ${cooldownActive ? 'active' : 'inactive'} (${Math.round(cooldownRemaining / 1000)}s remaining)`);
        
        // Test functions
        function testAuthFlow() {
            log('Testing auth flow...');
            
            // Simulate redirect
            const redirectData = JSON.parse(sessionStorage.getItem('pyebwaRedirectData') || '{}');
            redirectData.count = (redirectData.count || 0) + 1;
            redirectData.timestamp = Date.now();
            sessionStorage.setItem('pyebwaRedirectData', JSON.stringify(redirectData));
            
            log(`Redirect count: ${redirectData.count}`);
            
            // Check if we should block
            const maxRedirects = isTablet ? 4 : 2;
            if (redirectData.count > maxRedirects) {
                log(`LOOP DETECTED! Count ${redirectData.count} > ${maxRedirects}`, 'error');
                alert('Loop would be detected and blocked!');
            } else {
                log('Redirect would proceed normally');
            }
            
            // Update display
            location.reload();
        }
        
        function clearAllData() {
            if (confirm('Clear all authentication data?')) {
                localStorage.clear();
                sessionStorage.clear();
                log('All data cleared');
                location.reload();
            }
        }
        
        // Monitor for errors
        window.addEventListener('error', (e) => {
            log(`ERROR: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });
        
        // Check for auth loop indicators
        const checkLoopIndicators = () => {
            const indicators = [];
            
            // Check redirect count
            const redirectData = JSON.parse(sessionStorage.getItem('pyebwaRedirectData') || '{}');
            if (redirectData.count > 0) {
                indicators.push(`Redirect count: ${redirectData.count}`);
            }
            
            // Check cooldown
            if (cooldownActive) {
                indicators.push(`Cooldown active: ${Math.round(cooldownRemaining / 1000)}s remaining`);
            }
            
            // Check recent login flags
            if (sessionStorage.getItem('recentLogin') === 'true') {
                indicators.push('Recent login flag set');
            }
            
            // Check auth wait
            if (sessionStorage.getItem('authWaitSuccess') === 'true') {
                indicators.push('Auth wait success flag set');
            }
            
            if (indicators.length > 0) {
                log('Loop indicators found: ' + indicators.join(', '), 'warning');
            }
        };
        
        checkLoopIndicators();
        
        // Additional test functions for new sections
        
        // Loop Detection Test
        function updateLoopTest() {
            const loopTest = document.getElementById('loopTest');
            const visitCount = parseInt(localStorage.getItem('pyebwaVisitCount') || '0');
            const lastVisit = parseInt(localStorage.getItem('pyebwaLastVisit') || '0');
            const now = Date.now();
            const threshold = isTablet ? 5 : 3;
            const timeWindow = isTablet ? 15000 : 10000;
            const timeSinceLastVisit = now - lastVisit;
            
            loopTest.innerHTML = `
                <div class="status info">Visit Count: ${visitCount}</div>
                <div class="status info">Threshold: ${threshold} visits in ${timeWindow/1000}s</div>
                <div class="status info">Time Since Last Visit: ${Math.round(timeSinceLastVisit/1000)}s</div>
                <div class="status ${visitCount >= threshold ? 'error' : 'success'}">
                    Loop Status: ${visitCount >= threshold ? 'LOOP DETECTED!' : 'Normal'}
                </div>
            `;
        }
        
        function simulateLoop() {
            log('Simulating rapid visits for loop detection...');
            const visits = isTablet ? 6 : 4;
            
            for (let i = 0; i < visits; i++) {
                const count = parseInt(localStorage.getItem('pyebwaVisitCount') || '0') + 1;
                localStorage.setItem('pyebwaVisitCount', count.toString());
                localStorage.setItem('pyebwaLastVisit', Date.now().toString());
                log(`Visit ${count} recorded`);
            }
            
            updateLoopTest();
            log('Loop simulation complete', 'warning');
        }
        
        function clearLoopData() {
            localStorage.removeItem('pyebwaVisitCount');
            localStorage.removeItem('pyebwaLastVisit');
            localStorage.removeItem('pyebwaLoopDetected');
            log('Loop detection data cleared');
            updateLoopTest();
        }
        
        // Cross-Domain Test
        function updateCrossDomainTest() {
            const crossDomainTest = document.getElementById('crossDomainTest');
            const currentDomain = window.location.hostname;
            const authToken = firebase.auth().currentUser ? 'Present' : 'None';
            
            crossDomainTest.innerHTML = `
                <div class="status info">Current Domain: ${currentDomain}</div>
                <div class="status info">Auth Token: ${authToken}</div>
                <div class="status info">
                    Related Domains: rasin.pyebwa.com, pyebwa.com
                </div>
            `;
        }
        
        async function testCrossDomain() {
            log('Testing cross-domain authentication...');
            
            if (firebase.auth().currentUser) {
                try {
                    const token = await firebase.auth().currentUser.getIdToken();
                    log('Auth token retrieved successfully');
                    log(`Token preview: ${token.substring(0, 20)}...`);
                    
                    // Test token validity
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const expiry = new Date(payload.exp * 1000);
                    log(`Token expires: ${expiry.toLocaleString()}`);
                } catch (error) {
                    log(`Token retrieval error: ${error.message}`, 'error');
                }
            } else {
                log('No authenticated user for cross-domain test', 'warning');
            }
            
            updateCrossDomainTest();
        }
        
        // Performance Metrics
        function updatePerformanceTest() {
            const performanceTest = document.getElementById('performanceTest');
            
            if (window.performance && window.performance.timing) {
                const timing = window.performance.timing;
                const pageLoad = timing.loadEventEnd - timing.navigationStart;
                const domReady = timing.domContentLoadedEventEnd - timing.navigationStart;
                const redirectTime = timing.redirectEnd - timing.redirectStart;
                
                let html = `
                    <div class="status info">Page Load Time: ${pageLoad}ms</div>
                    <div class="status info">DOM Ready Time: ${domReady}ms</div>
                    <div class="status info">Redirect Time: ${redirectTime}ms</div>
                `;
                
                if (window.performance.memory) {
                    const mem = window.performance.memory;
                    html += `
                        <div class="status info">
                            Memory: ${Math.round(mem.usedJSHeapSize / 1048576)}MB / 
                            ${Math.round(mem.totalJSHeapSize / 1048576)}MB
                        </div>
                    `;
                }
                
                performanceTest.innerHTML = html;
            } else {
                performanceTest.innerHTML = '<div class="status warning">Performance API not available</div>';
            }
        }
        
        // Automated Tests
        let testSuite = null;
        let testResults = null;
        
        async function runAutomatedTests() {
            const automatedTests = document.getElementById('automatedTests');
            automatedTests.innerHTML = '<div class="status warning">Running automated tests...</div>';
            log('Starting automated test suite...');
            
            if (!window.TabletAuthTestSuite) {
                automatedTests.innerHTML = '<div class="status error">Test suite not loaded!</div>';
                log('ERROR: TabletAuthTestSuite not available', 'error');
                return;
            }
            
            try {
                testSuite = new TabletAuthTestSuite(firebase);
                testResults = await testSuite.runAll();
                
                const { summary } = testResults;
                automatedTests.innerHTML = `
                    <div class="status ${summary.failed === 0 ? 'success' : 'error'}">
                        Total: ${summary.total} | Passed: ${summary.passed} | Failed: ${summary.failed}
                    </div>
                    <div class="status info">Duration: ${summary.duration}ms</div>
                `;
                
                // Log failed tests
                if (summary.failed > 0) {
                    testResults.results.filter(r => r.status === 'failed').forEach(test => {
                        log(`FAILED: ${test.name} - ${test.error}`, 'error');
                    });
                }
                
                log(`Test suite complete: ${summary.passed}/${summary.total} passed`);
            } catch (error) {
                automatedTests.innerHTML = `<div class="status error">Test error: ${error.message}</div>`;
                log(`Test suite error: ${error.message}`, 'error');
            }
        }
        
        function exportTestResults() {
            if (!testResults) {
                alert('No test results to export. Run tests first.');
                return;
            }
            
            if (testSuite) {
                testSuite.exportResults();
                log('Test results exported');
            }
        }
        
        // Initialize new tests
        updateLoopTest();
        updateCrossDomainTest();
        updatePerformanceTest();
        
        // Auto-refresh performance metrics
        setInterval(updatePerformanceTest, 5000);
        
        // Check for tablet-specific scripts
        if (window.DeviceDetection && window.DeviceDetection.isTablet()) {
            log('Tablet detected - tablet-specific scripts should be active', 'warning');
            
            // Check if tablet debug is loaded
            if (window.tabletDebugInfo) {
                log('Tablet debug helper is active');
            }
        }
    </script>
</body>
</html>